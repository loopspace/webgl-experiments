<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>webgl Experiments: Voronoi Diagrams</title>
    <script src="../utilities/sylvester.js"></script>
    <script src="../utilities/glUtils.js"></script>
    <script src="image.js"></script>
    <script src="voronoi.js"></script>
    <script src="main.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Sunflower:300"
      rel="stylesheet">
    <link href="voronoi.css" rel="stylesheet">
<script id="shader-fs" type="x-shader/x-fragment">
  //The interpolated coordinate for this fragment
  varying highp vec2 vCoordinate;

  uniform sampler2D texture; // image of pitch for background
  uniform lowp vec2 pts[22]; // positions of players
  uniform lowp vec3 params[22]; // variations of distance
  uniform lowp float wgts;
  uniform lowp float dlys;
  uniform lowp float exts;
  uniform lowp float lin;
  uniform highp float aspect; // aspect ratio of pitch image
  uniform lowp float tms; // which teams to show
  uniform lowp vec2 ball; // position of ball
  uniform lowp float bplyr; // index of player closest to ball
  uniform lowp float regions; // colour all regions or just wireframe

  void main()
  {
      lowp float st = 11. * (1. - mod(tms,2.));
      lowp float ed = 11. * (1. + floor(tms/2.));
      lowp float d = 2.; // shortest actual distance
      lowp float dd; // actual distance to current point
      lowp float a = 2.; // alternative metric distance
      lowp float ad; // alternative metric distance 
      lowp float ld; // variations of distance
      lowp float p = 0.; // index of nearest player
      lowp vec2 pt = pts[0]; // location of nearest player
      lowp float s;
      lowp float t;
      lowp float w = 0.; // for locating boundary between regions
      lowp vec2 tc;
      lowp vec4 col;
      lowp vec4 tcol;

      // pitch background
      lowp vec4 pcol = texture2D(texture, vCoordinate);
      // highlight colour
      lowp vec4 red = vec4(1.,0.,0.,1.);
      lowp vec4 blue = vec4(0.,0.,1.,1.);
    
      for (int i = 0; i < 22; i++) {
	  // Adjust vector to i-th point to take aspect ratio into account
	  tc = vCoordinate - pts[i];
	  tc.x *= aspect;
	  // Distance to current player
	  dd = length(tc);

	  // Adjusted distance, if requested
	  ld = -(1. - lin) * log(
	      max(.0001,
		  (1. - (1. + exts * (params[i].z - 1.)) * dd)))
	      + lin * dd;
	  
	  ad = (1. + wgts * (params[i].x - 1.)) * ld + dlys *
	      params[i].y;

	  // s is 0 if the new adjusted distance is shorter
	  s = 1. - (1. - step(a,ad))
	      * (1. - step(float(i),st))
	      * (1. - step(ed,float(i)))
	  ;
	  // t is 0 if the new actual distance is shorter
	  t = 1. - (1. - step(d,dd))
	      * (1. - step(float(i),st))
	      * (1. - step(ed,float(i)))
	  ;
	  // w is 1 if there is a new shortest distance and it is
	  // nearly the same as the current distance, or if the latest
	  // distance is not the shortest but is very close
	  w = (1.-s)*( step(abs(d*d - dd*dd),0.007 * distance(pts[i],pt)) )
	      + s* max(w,
		       step(abs(d*d - dd*dd),0.007 *
			    distance(pts[i],pt)
			   )
		       * (1. - step(float(i),st))
		       * (1. - step(ed,float(i)))
		      );
	  // adjust the index of the current point
          p = (1.-s)*(float (i)) + s*p;
	  // adjust the location of the current point
	  pt = (1.-s)*pts[i] + s*pt;
	  // shortest adjusted distance
          a = s*a + (1.-s)*ad;
	  // shortest actual distance
          d = t*d + (1.-t)*dd;
      }

      // highlight region with the ball
      s = step(p,bplyr) * step(bplyr, p);
      pcol = (1. - s) * pcol + s *
	  (.6 * pcol + .4 *
	   (floor(p/11.) * red
	    + (1. - floor(p/11.)) * blue)
	  );

      // set the team colour
      tcol = ( red * floor(p/11.)
	      + blue * (1. - floor(p/11.)) ); 
      
      // highlight the player locations or boundaries
      s = max( step(d,.01) , w);
      
      col =  tcol * s
      	  + (1. - s) * pcol;

      // Distance to ball position
      tc = vCoordinate - ball;
      tc.x *= aspect;
      dd = length(tc);

      s = step(dd,0.01);
      col = s * vec4(1.) + (1. - s) * col;

      // If regions is requested, just show those
      col = regions * tcol + (1. - regions) * col;
      
      gl_FragColor = col;
  }
    </script>
    <script id="shader-vs" type="x-shader/x-vertex">
      attribute vec3 aVertexPosition;
      attribute vec2 aVertexCoordinate;
    
      uniform mat4 uMVMatrix;
      uniform mat4 uPMatrix;
      
      varying highp vec2 vCoordinate;
    
      void main(void) {
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        vCoordinate = aVertexCoordinate;
      }
    </script>
  </head>
  <body onload="start()">
    <div class="texture">
      <img id="pitch" src="football.png">
    </div>
    <div id="container">
    <canvas id="glCanvas" width="640" height="480">
      Your browser doesn't appear to support the 
      <code>&lt;canvas&gt;</code> element.
    </canvas>
    </div>
    <div id="offscreen">
    <canvas id="imgCanvas" width="640" height="480">
      Your browser doesn't appear to support the 
      <code>&lt;canvas&gt;</code> element.
    </canvas>
    <img id="regions">
    <canvas id="regionCanvas" width="1024" height="1024">
      Your browser doesn't appear to support the 
      <code>&lt;canvas&gt;</code> element.
    </canvas>
    </div>
    <div id="info">
      <form id="vform"></form>
      <table>
	<tr>
	  <th colspan="2">Football Configuration</th>
	</tr>
	<tr>
	  <td>Team A</td>
	  <td id="teamA" class="rightalign"><input type="checkbox" id="tmA" form="vform"></td>
	</tr>
	<tr>
	  <td>Team B</td>
	  <td id="teamB" class="rightalign"><input type="checkbox"
	  id="tmB" form="vform" checked="checked"></td>
	</tr>
	<!--
	<tr>
	  <td>Parameters</td><td></td>
	</tr>
	  <tr class="linear">
	    <td class="centrealign" colspan="2">
	      <math xmlns='http://www.w3.org/1998/Math/MathML'
	      display='inline'><semantics><mrow><mi>a</mi><mi>x</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding='application/x-tex'>a
		    x + b</annotation></semantics></math>
	    </td>
	  </tr>
	<tr class="log">
	  <td class="centrealign" colspan="2">
	    <math xmlns='http://www.w3.org/1998/Math/MathML' display='inline'><semantics><mrow><mo lspace="verythinmathspace" rspace="0em">&minus;</mo><mi>a</mi><mi>log</mi><mo stretchy="false">(</mo><mn>1</mn><mo>&minus;</mo><mi>c</mi><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mi>b</mi></mrow><annotation encoding='application/x-tex'>&#x2d;a \log(1 &#x2d; c x) + b</annotation></semantics></math>
	    </td>
	  </tr>
	<tr class="singleparam">
	  <td class="rightalign"><math xmlns='http://www.w3.org/1998/Math/MathML' display='inline'><semantics><mrow><mi>a</mi></mrow><annotation encoding='application/x-tex'>a</annotation></semantics></math>:</td>
	  <td><input type="text" id="wgt" form="vform" class="smallinput"></td>
	</tr>
	<tr class="singleparam">
	  <td class="rightalign"><math xmlns='http://www.w3.org/1998/Math/MathML' display='inline'><semantics><mrow><mi>b</mi></mrow><annotation encoding='application/x-tex'>b</annotation></semantics></math>:</td>
	  <td><input type="text" id="dis" form="vform" class="smallinput"></td>
	</tr>
	<tr id="extent" class="log singleparam">
	  <td class="rightalign"><math xmlns='http://www.w3.org/1998/Math/MathML' display='inline'><semantics><mrow><mi>c</mi></mrow><annotation encoding='application/x-tex'>c</annotation></semantics></math>:</td>
	  <td><input type="text" id="qnt" form="vform" class="smallinput"></td>
	</tr>
	  <tr class="multipleparam">
	    <td>
	      Use Weights
	    </td>
	    <td>
	      <input type="checkbox" id="wgts">
	    </td>
	  </tr>
	  <tr class="multipleparam">
	    <td>
	      Use Delays
	    </td>
	    <td>
	      <input type="checkbox" id="dlys">
	    </td>
	  </tr>
	  <tr id="extents" class="log multipleparam">
	    <td>
	      Use Extents
	    </td>
	    <td>
	      <input type="checkbox" id="exts">
	    </td>
	  </tr>
	  <tr class="multipleparam">
	    <td colspan="2">
	      <button type="button" id="regenerate">Regenerate Parameters</button>
	    </td>
	  </tr>
	  <tr>
	    <td colspan="2">
	      <a id="dl" download="Voronoi.png" href="#" class="button">Download Diagram</a>
	    </td>
	  </tr>
-->
      </table>
    </div>
    <div id="help" class="help">
      <h3>Voronoi Football</h3>
      <p>
	This page allows you to explore the Voronoi diagram for a
	football team.
      </p>
      <p>
      </p>
    </div>
    <div id="helpsign" class="help">
      <a href="#" id="helplink">?</a>
    </div>
  </body>
</html>
